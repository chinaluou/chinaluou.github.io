
<!DOCTYPE html>
<html lang="ru">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Tornado&#39;s Blog">
    <title>CODSYS功能块建库移植到底层平台 - Tornado&#39;s Blog</title>
    <meta name="author" content="Tornado">
    
    
        <link rel="icon" href="http://chinaluou.github.io/assets/images/Ture">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="1. CODSYS平台Lib库的建立
本文以CODSYS V3.5 SP6平台建立一个温度控制PID算法建库，在CODSYS中建立函数接口，具体算法在底层实现。

打开CODSYS软件，点击”新建工程”，选择”函数库”中的”空白库”，设定文件目录和文件名，如文件夹为：”Temperature”文件名为：”CmpTemperature”，然后确认。
在POU中选中”CmpTemperature”，右">
<meta property="og:type" content="blog">
<meta property="og:title" content="CODSYS功能块建库移植到底层平台">
<meta property="og:url" content="http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/index.html">
<meta property="og:site_name" content="Tornado's Blog">
<meta property="og:description" content="1. CODSYS平台Lib库的建立
本文以CODSYS V3.5 SP6平台建立一个温度控制PID算法建库，在CODSYS中建立函数接口，具体算法在底层实现。

打开CODSYS软件，点击”新建工程”，选择”函数库”中的”空白库”，设定文件目录和文件名，如文件夹为：”Temperature”文件名为：”CmpTemperature”，然后确认。
在POU中选中”CmpTemperature”，右">
<meta property="og:image" content="http://omsnt3z0g.bkt.clouddn.com/New%20Project.png">
<meta property="og:image" content="http://omsnt3z0g.bkt.clouddn.com/Add%20FB.png">
<meta property="og:image" content="http://omsnt3z0g.bkt.clouddn.com/Add%20FB1.png">
<meta property="og:image" content="http://omsnt3z0g.bkt.clouddn.com/Add%20FB2.png">
<meta property="og:image" content="http://omsnt3z0g.bkt.clouddn.com/Add%20FB3.png">
<meta property="og:image" content="http://omsnt3z0g.bkt.clouddn.com/Add%20FB4.png">
<meta property="og:image" content="http://omsnt3z0g.bkt.clouddn.com/Project%20tree.png">
<meta property="og:updated_time" content="2018-04-11T01:07:08.820Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CODSYS功能块建库移植到底层平台">
<meta name="twitter:description" content="1. CODSYS平台Lib库的建立
本文以CODSYS V3.5 SP6平台建立一个温度控制PID算法建库，在CODSYS中建立函数接口，具体算法在底层实现。

打开CODSYS软件，点击”新建工程”，选择”函数库”中的”空白库”，设定文件目录和文件名，如文件夹为：”Temperature”文件名为：”CmpTemperature”，然后确认。
在POU中选中”CmpTemperature”，右">
<meta name="twitter:image" content="http://omsnt3z0g.bkt.clouddn.com/New%20Project.png">
    
    
        
    
    
        <meta property="og:image" content="http://chinaluou.github.io/assets/images/head.jpeg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-nuvue6sithwirecbhvw3dkaobiojqvtadsnhguwi7k04xklybw5djl1smadp.min.css">
    <!--STYLES END-->
    
    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?9bf3bdab9ef46807b0d53c656d70c49c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">Tornado&#39;s Blog</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/head.jpeg"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/head.jpeg"/>
            </a>
            <span class="sidebar-profile-name">Tornado</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">首页</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-th"></i>
                    <span class="sidebar-button-desc">分类</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">标签</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">归档</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-user"></i>
                    <span class="sidebar-button-desc">关于</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/chinaluou" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="http://weibo.com/3051010605" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-weibo"></i>
                    <span class="sidebar-button-desc">微博</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            CODSYS功能块建库移植到底层平台
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" datetime="2018-04-10T22:12:37+08:00">
	
		    2018/04/10 22:12:37
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/CODSYS/">CODSYS</a>


    
</div>

</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <h1 id="1-CODSYS平台Lib库的建立"><a href="#1-CODSYS平台Lib库的建立" class="headerlink" title="1. CODSYS平台Lib库的建立"></a>1. CODSYS平台Lib库的建立</h1><hr>
<p>本文以CODSYS V3.5 SP6平台建立一个温度控制PID算法建库，在CODSYS中建立函数接口，具体算法在底层实现。</p>
<ol>
<li>打开CODSYS软件，点击”新建工程”，选择”函数库”中的”空白库”，设定文件目录和文件名，如文件夹为：”Temperature”文件名为：”CmpTemperature”，然后确认。<br><img src="http://omsnt3z0g.bkt.clouddn.com/New%20Project.png" alt="New Project"></li>
<li>在POU中选中”CmpTemperature”，右键”添加对象”，单击”程序组织单元…”。<br><img src="http://omsnt3z0g.bkt.clouddn.com/Add%20FB.png" alt="Add FB"></li>
<li>在创建新的POU窗口中，输入名称”MC_TemperatureRegulator”,类型为”功能块”，实现语言为”功能块图(FBD)”，然后点击打开。<br><img src="http://omsnt3z0g.bkt.clouddn.com/Add%20FB1.png" alt="Add FB1"></li>
<li>在POU中选中”MC_TemperatureRegulator”，右键”添加对象”，单击”方法…”。<br><img src="http://omsnt3z0g.bkt.clouddn.com/Add%20FB2.png" alt="Add FB2"></li>
<li>在创建新的方法窗口中，输入名称”FB_Init”，实现语言为”功能块图(FBD)”，然后点击打开。<br><img src="http://omsnt3z0g.bkt.clouddn.com/Add%20FB3.png" alt="Add FB3"></li>
<li>在POU中右键”MC_TemperatureRegulator”，单击”属性…”，单击”编译”选项卡，勾选”外部实现(E)(稍后在系统运行时连接)”，点击确认。同样对”FB_Init”，也进行同样的操作。（因为我们只是在CODSYS中定义接口函数，具体执行放到底层硬件中去实现）<br><img src="http://omsnt3z0g.bkt.clouddn.com/Add%20FB4.png" alt="Add FB4"></li>
<li><p>在POU中双击”MC_TemperatureRegulator”，然后在右侧变量窗口中填写功能块的接口数参数，其中Axis、TemperatureExpect、TemperatureActual、DutyRatio为自定义参数，其他参数为默认参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="string">FUNCTION_BLOCK</span> <span class="string">MC_TemperatureRegulator</span></div><div class="line"></div><div class="line"><span class="string">(*</span> <span class="string">Function</span> <span class="string">block</span> <span class="string">for</span> <span class="string">temperature</span> <span class="string">control</span> <span class="string">*)</span></div><div class="line"><span class="string">(*</span> <span class="string">Function</span> <span class="string">block</span> <span class="string">for</span> <span class="string">PWM</span> <span class="string">duty</span> <span class="string">ratio</span> <span class="string">from</span> <span class="string">expect</span> <span class="string">temperature</span> <span class="string">and</span> <span class="string">actual</span> <span class="string">temperature</span> <span class="string">to</span> <span class="string">Fuzzy</span> <span class="string">*)</span></div><div class="line"></div><div class="line"><span class="string">VAR_IN_OUT</span></div><div class="line"><span class="attr">  Axis:</span> <span class="string">hAxis_REF;</span>				<span class="string">(*</span> <span class="string">Reference</span> <span class="string">to</span> <span class="string">the</span> <span class="string">Axis</span> <span class="string">*)</span></div><div class="line"><span class="string">END_VAR</span></div><div class="line"><span class="string">VAR_INPUT</span></div><div class="line"><span class="attr">  Execute:</span> <span class="string">BOOL</span> <span class="string">:=</span> <span class="number">0</span><span class="string">;</span>     		<span class="string">(*</span> <span class="string">Start</span> <span class="string">the</span> <span class="string">motion</span> <span class="string">at</span> <span class="string">rising</span> <span class="string">edge</span> <span class="string">*)</span></div><div class="line"><span class="attr">  TemperatureExpect:</span> <span class="string">REAL</span> <span class="string">:=</span> <span class="number">0.0</span><span class="string">;</span> 	<span class="string">(*</span> <span class="string">Expect</span> <span class="string">temperature.</span> <span class="string">In</span> <span class="string">technical</span> <span class="string">unit</span> <span class="string">[degree</span> <span class="string">C]</span> <span class="string">*)</span></div><div class="line"><span class="attr">  TemperatureActual:</span> <span class="string">REAL</span> <span class="string">:=</span> <span class="number">0.0</span><span class="string">;</span>	<span class="string">(*</span> <span class="string">Actual</span> <span class="string">temperature.</span> <span class="string">In</span> <span class="string">technical</span> <span class="string">unit</span> <span class="string">[degree</span> <span class="string">C]</span> <span class="string">*)</span>  </div><div class="line"><span class="string">END_VAR</span></div><div class="line"><span class="string">VAR_OUTPUT</span></div><div class="line"><span class="attr">  DutyRatio:</span> <span class="string">REAL</span> <span class="string">:=</span> <span class="number">0</span><span class="string">;</span>			<span class="string">(*</span> <span class="string">PWM</span> <span class="string">duty</span> <span class="string">ratio</span> <span class="string">(0.0</span> <span class="string">~</span> <span class="number">100.0</span><span class="string">)</span> <span class="string">*)</span></div><div class="line"><span class="attr">  Done:</span> <span class="string">BOOL</span> <span class="string">:=</span> <span class="number">0</span><span class="string">;</span>       		<span class="string">(*</span> <span class="string">Commanded</span> <span class="string">is</span> <span class="string">done</span> <span class="string">*)</span></div><div class="line"><span class="attr">  Busy:</span> <span class="string">BOOL</span> <span class="string">:=</span> <span class="number">0</span><span class="string">;</span>       		<span class="string">(*</span> <span class="string">The</span> <span class="string">FB</span> <span class="string">is</span> <span class="string">not</span> <span class="string">finished</span> <span class="string">*)</span></div><div class="line"><span class="attr">  Error:</span> <span class="string">BOOL</span> <span class="string">:=</span> <span class="number">0</span><span class="string">;</span>      		<span class="string">(*</span> <span class="string">Signals</span> <span class="string">that</span> <span class="string">an</span> <span class="string">error</span> <span class="string">has</span> <span class="string">occurred</span> <span class="string">within</span> <span class="string">the</span> <span class="string">function</span> <span class="string">block</span> <span class="string">*)</span></div><div class="line"><span class="attr">  ErrorID:</span> <span class="string">WORD</span> <span class="string">:=</span> <span class="number">1</span><span class="string">;</span>       	<span class="string">(*</span> <span class="string">Error</span> <span class="string">identification</span> <span class="string">*)</span></div><div class="line"><span class="string">END_VAR</span></div><div class="line"><span class="string">VAR</span></div><div class="line"><span class="string">END_VAR</span></div></pre></td></tr></table></figure>
</li>
<li><p>在POU中双击”FB_Init”，然后在右侧变量窗口中填写功能块的接口数参数，其中参数为默认参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="string">METHOD</span> <span class="string">FB_Init</span> <span class="string">:</span> <span class="string">BOOL</span></div><div class="line"><span class="string">VAR_INPUT</span></div><div class="line">	<span class="attr">bInitRetains:</span> <span class="string">BOOL;</span></div><div class="line">	<span class="attr">bInCopyCode:</span> <span class="string">BOOL;</span></div><div class="line"><span class="string">END_VAR</span></div><div class="line"><span class="string">```</span> </div><div class="line"><span class="number">8.</span> <span class="string">由于在"MC_TemperatureRegulator"的参数申明中，使用私有数据类型"hAxis_REF"，因此编译会报错提示"C0077:</span>  <span class="string">未知的类型:</span> <span class="string">'hAxis_REF'</span><span class="string">"，这个数据类型申明在数据类型库中进行了定义，因此需要添加这个库。在POU中右击"</span><span class="string">CmpTemperature"，选择"添加对象"，单击"库管理器..."，点击"打开"。然后在右侧单击"添加库"，在"杂项"中，选中"PLCOpen</span> <span class="string">Motion</span> <span class="string">Basic"，点击确认，就完成了库的添加，也可以看库中定义的数据类型。（当然在POU中添加"PLCOpen</span> <span class="string">Motion</span> <span class="string">Basic"这个库，前提是已经在"工具"栏中，"安装库..."中完成了这个库导入CODSYS）</span></div><div class="line"><span class="string">![Add</span> <span class="string">FB5](http://omsnt3z0g.bkt.clouddn.com/Add%20FB5.png)</span></div><div class="line"><span class="number">9.</span> <span class="string">选择菜单栏中的"编译"，单击"检测所有池对象"，对程序进行错误检测，如果没有错误后，选择选择菜单栏中的"编译"，单击"生产运行时系统文件"，勾选"C根文件"后点击"确认"。</span></div><div class="line"><span class="string">![Add</span> <span class="string">FB6](http://omsnt3z0g.bkt.clouddn.com/Add%20FB6.png)</span></div><div class="line"><span class="number">10.</span> <span class="string">此时，会在文件目录下生成"CmpTemperature.library"、"CmpTemperature.c"、"CmpTemperatureItf.m4"等文件，至此就完成了CODSYS平台下的Lib库的建立。</span></div><div class="line"> </div><div class="line"><span class="comment"># 2. 生成底层平台所需要的文件</span></div><div class="line"><span class="bullet">-</span><span class="bullet">---------</span></div><div class="line"><span class="number">1.</span> <span class="string">在其他目录下新建一个文件夹"Temperature"，拷贝CODSYS生成"CmpTemperature.library"、"CmpTemperature.c"、"CmpTemperatureItf.m4"文件，到新建的文件夹。</span></div><div class="line"><span class="number">2.</span> <span class="string">在新建文件夹中新建文件"CmpTemperatureItf.m4"，具体内容如下所示：</span></div><div class="line"><span class="string">```</span> <span class="string">yaml</span></div><div class="line"><span class="string">/**</span></div><div class="line"> <span class="string">*</span>  <span class="string">&lt;name&gt;Component</span> <span class="string">Template&lt;/name&gt;</span></div><div class="line"> <span class="string">*</span>  <span class="string">&lt;description&gt;</span> </div><div class="line"> <span class="string">*</span>  <span class="string">An</span> <span class="string">example</span> <span class="string">on</span> <span class="string">how</span> <span class="string">to</span> <span class="string">implement</span> <span class="string">a</span> <span class="string">component.</span></div><div class="line"> <span class="string">*</span>  <span class="string">This</span> <span class="string">component</span> <span class="string">does</span> <span class="literal">no</span> <span class="string">usefull</span> <span class="string">work</span> <span class="string">and</span> <span class="string">it</span> <span class="string">exports</span> <span class="literal">no</span> <span class="string">functions</span></div><div class="line"> <span class="string">*</span>  <span class="string">which</span> <span class="string">are</span> <span class="string">intended</span> <span class="string">to</span> <span class="string">be</span> <span class="string">used</span> <span class="string">for</span> <span class="string">anything.</span> <span class="string">Use</span> <span class="string">at</span> <span class="string">your</span> <span class="string">own</span> <span class="string">risk.</span></div><div class="line"> <span class="string">*</span>  <span class="string">&lt;/description&gt;</span></div><div class="line"> <span class="string">*</span>  <span class="string">&lt;copyright&gt;</span></div><div class="line"> <span class="string">*</span>  <span class="string">(c)</span> <span class="number">2003</span><span class="bullet">-2016</span> <span class="number">3</span><span class="string">S-Smart</span> <span class="string">Software</span> <span class="string">Solutions</span></div><div class="line"> <span class="string">*</span>  <span class="string">&lt;/copyright&gt;</span></div><div class="line"> <span class="string">*/</span></div><div class="line"><span class="string">SET_COMPONENT_NAME(`CmpTemperature')</span></div><div class="line"><span class="string">COMPONENT_SOURCES(`CmpTemperature.c')</span></div><div class="line"></div><div class="line"><span class="string">COMPONENT_VERSION(`0x03050600')</span></div><div class="line"></div><div class="line"><span class="string">/*</span> <span class="attr">NOTE:</span> <span class="string">REPLACE</span> <span class="number">0x0001</span> <span class="string">BY</span> <span class="string">YOUR</span> <span class="string">VENDORID</span> <span class="string">*/</span></div><div class="line"><span class="string">COMPONENT_VENDORID(`0x0001')</span>				</div><div class="line"></div><div class="line"><span class="comment">#define CMPID_CmpTemperature		0x2000								/* <span class="doctag">NOTE:</span> START HERE WITH YOUR COMPONENTIDS (see CmpItf.h */</span></div><div class="line"><span class="comment">#define CLASSID_CCmpTemperature	ADDVENDORID(CMP_VENDORID, 0x2000)	/* <span class="doctag">NOTE:</span> START HERE WITH YOUR CLASSIDS (see CmpItf.h */</span></div><div class="line"><span class="comment">#define ITFID_ICmpTemperature		ADDVENDORID(CMP_VENDORID, 0x2000)	/* <span class="doctag">NOTE:</span> START HERE WITH YOUR INTERFACEIDS (see CmpItf.h */</span></div><div class="line"></div><div class="line"><span class="string">CATEGORY(`Hilectro')</span></div><div class="line"></div><div class="line"><span class="string">IMPLEMENT_ITF(`CmpTemperatureItf.m4')</span></div></pre></td></tr></table></figure>
</li>
<li><p>在新建文件夹中新建批处理文件”CmpTemperatureDep_m4.bat”，具体内容如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="string">echo.</span>        <span class="string">*</span> <span class="string">CmpTemperatureDep.m4</span> <span class="string">...</span> <span class="string">CmpTemperatureDep.h</span> </div><div class="line"></div><div class="line"><span class="string">start</span> <span class="string">/B</span> <span class="string">/WAIT</span> <span class="string">..\..\BuildUtils\msys\bin\generate_dep_withCpp.bat</span> <span class="string">CmpTemperatureDep</span> <span class="string">..\..\BuildUtils\msys\bin</span> <span class="string">../../BuildUtils/M4Defs</span> <span class="string">../../Components</span> </div><div class="line"><span class="string">```</span> </div><div class="line"><span class="number">4.</span> <span class="string">在新建文件夹中新建批处理文件"CmpTemperatureItf_m4.bat"，具体内容如下所示：</span></div><div class="line"><span class="string">```</span> <span class="string">yaml</span></div><div class="line"></div><div class="line"><span class="string">echo.</span>        <span class="string">*</span> <span class="string">CmpTemperatureItf.m4</span> <span class="string">...</span> <span class="string">CmpTemperatureItf.h</span> </div><div class="line"></div><div class="line"><span class="string">start</span> <span class="string">/B</span> <span class="string">/WAIT</span> <span class="string">..\..\BuildUtils\msys\bin\generate_itf.bat</span> <span class="string">CmpTemperatureItf</span> <span class="string">..\..\BuildUtils\msys\bin</span> <span class="string">../../BuildUtils/M4Defs</span></div></pre></td></tr></table></figure>
</li>
<li><p>依次双击批处理文件”CmpTemperatureDep_m4.bat”、”CmpTemperatureItf_m4.bat”，会在目录下生成文件”CmpTemperature.cpp”、”CmpTemperatureDep.h”、”CmpTemperatureItf.h”三个文件。</p>
</li>
<li>至此底层平台所需的文件已经产生。</li>
</ol>
<h1 id="3-移植代码至底层平台"><a href="#3-移植代码至底层平台" class="headerlink" title="3. 移植代码至底层平台"></a>3. 移植代码至底层平台</h1><hr>
<p>本移植例程以笔者目前的A8工程平台下进行举例说明，笔者底层工程平台将底层和CODSYS连接所需的依赖关系和函数实现分开放置。底层和CODSYS连接所需的依赖关系文件放置在”CODSYS”目录下，函数实现放在”CMP”目录下。<br><img src="http://omsnt3z0g.bkt.clouddn.com/Project%20tree.png" alt="Project tree"></p>
<ol>
<li><p>在”CODSYS”的”H7”目录下新建文件夹”CmpTemperature”，在新建目录下新建”CmpTemperature.c”，具体内容如下（其中头文件根据实际目录进行添加和修改）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="string">/**</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;name&gt;CmpTemplate.c&lt;/name&gt;</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;description&gt;</span> </div><div class="line"> <span class="string">*</span>  <span class="string">Example</span> <span class="string">for</span> <span class="string">an</span> <span class="string">empty</span> <span class="string">runtime</span> <span class="string">component</span> <span class="string">frame</span> <span class="string">that</span> <span class="string">can</span> <span class="string">be</span> <span class="string">used</span> <span class="string">as</span> <span class="string">a</span> <span class="string">starting</span> <span class="string">point</span> <span class="string">to</span> <span class="string">develop</span> <span class="string">own</span> <span class="string">components.</span></div><div class="line"> <span class="string">*</span></div><div class="line"> <span class="string">*</span>  <span class="string">MANDATORY</span> <span class="attr">FUNCTIONS:</span></div><div class="line"> <span class="string">*</span>  <span class="bullet">-</span> <span class="string">ComponentEntry()</span></div><div class="line"> <span class="string">*</span>  <span class="bullet">-</span> <span class="string">ExportFunctions()</span></div><div class="line"> <span class="string">*</span>  <span class="bullet">-</span> <span class="string">ImportFunctions()</span></div><div class="line"> <span class="string">*</span>  <span class="bullet">-</span> <span class="string">CmpGetVersion()</span></div><div class="line"> <span class="string">*</span>  <span class="bullet">-</span> <span class="string">HookFunction()</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;/description&gt;</span></div><div class="line"> <span class="string">*</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;copyright&gt;(c)</span> <span class="number">2003</span><span class="bullet">-2016</span> <span class="number">3</span><span class="string">S-Smart</span> <span class="string">Software</span> <span class="string">Solutions&lt;/copyright&gt;</span></div><div class="line"> <span class="string">*/</span></div><div class="line"></div><div class="line"><span class="comment">#include "CmpStd.h"</span></div><div class="line"><span class="comment">#include "CmpTemperatureDep.h"</span></div><div class="line"></div><div class="line"><span class="comment">#include "../../../Application/CMP/include/mcReference.h"</span></div><div class="line"></div><div class="line"><span class="comment">#include "../../../Application/CMP/Temperature/header/mcTemperatureRegulatorFB.h"</span></div><div class="line"></div><div class="line"><span class="string">USE_STMT</span></div><div class="line"></div><div class="line"><span class="comment">#ifndef RTS_COMPACT_MICRO</span></div><div class="line"></div><div class="line"><span class="string">/**</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;description&gt;Entry</span> <span class="string">function</span> <span class="string">of</span> <span class="string">the</span> <span class="string">component.</span> <span class="string">Called</span> <span class="string">at</span> <span class="string">startup</span> <span class="string">for</span> <span class="string">each</span> <span class="string">component.</span> <span class="string">Used</span> <span class="string">to</span> <span class="string">exchange</span> <span class="string">function</span> <span class="string">pointers</span> <span class="string">with</span> <span class="string">the</span> <span class="string">component</span> <span class="string">manager.&lt;/description&gt;</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;param</span> <span class="string">name="pInitStruct"</span> <span class="string">type="IN"&gt;Pointer</span> <span class="string">to</span> <span class="string">structure</span> <span class="attr">with:</span></div><div class="line"> <span class="string">*</span>		<span class="string">pfExportFunctions</span>	<span class="string">OUT</span> <span class="string">Pointer</span> <span class="string">to</span> <span class="string">function</span> <span class="string">that</span> <span class="string">exports</span> <span class="string">component</span> <span class="string">functions</span></div><div class="line"> <span class="string">*</span>		<span class="string">pfImportFunctions</span>	<span class="string">OUT</span> <span class="string">Pointer</span> <span class="string">to</span> <span class="string">function</span> <span class="string">that</span> <span class="string">imports</span> <span class="string">functions</span> <span class="string">from</span> <span class="string">other</span> <span class="string">components</span></div><div class="line"> <span class="string">*</span>		<span class="string">pfGetVersion</span>		<span class="string">OUT</span> <span class="string">Pointer</span> <span class="string">to</span> <span class="string">function</span> <span class="string">to</span> <span class="string">get</span> <span class="string">component</span> <span class="string">version</span></div><div class="line"> <span class="string">*</span>		<span class="string">pfRegisterAPI</span>		<span class="string">IN</span>	<span class="string">Pointer</span> <span class="string">to</span> <span class="string">component</span> <span class="string">mangager</span> <span class="string">function</span> <span class="string">to</span> <span class="string">register</span> <span class="string">a</span> <span class="string">api</span> <span class="string">function</span></div><div class="line"> <span class="string">*</span>		<span class="string">pfGetAPI</span>			<span class="string">IN</span>	<span class="string">Pointer</span> <span class="string">to</span> <span class="string">component</span> <span class="string">mangager</span> <span class="string">function</span> <span class="string">to</span> <span class="string">get</span> <span class="string">a</span> <span class="string">api</span> <span class="string">function</span></div><div class="line"> <span class="string">*</span>		<span class="string">pfCallHook</span>			<span class="string">IN</span>	<span class="string">Pointer</span> <span class="string">to</span> <span class="string">component</span> <span class="string">mangager</span> <span class="string">function</span> <span class="string">to</span> <span class="string">call</span> <span class="string">a</span> <span class="string">hook</span> <span class="string">function</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;/param&gt;</span> </div><div class="line"> <span class="string">*</span> <span class="string">&lt;result&gt;ERR_OK</span> <span class="string">if</span> <span class="string">component</span> <span class="string">could</span> <span class="string">be</span> <span class="string">initialized,</span> <span class="string">else</span> <span class="string">error</span> <span class="string">code.&lt;/result&gt;</span></div><div class="line"> <span class="string">*/</span></div><div class="line"><span class="string">DLL_DECL</span> <span class="string">int</span> <span class="string">CDECL</span> <span class="string">ComponentEntry(INIT_STRUCT</span> <span class="string">*pInitStruct)</span></div><div class="line"><span class="string">&#123;</span></div><div class="line">	<span class="string">pInitStruct-&gt;CmpId</span> <span class="string">=</span> <span class="string">COMPONENT_ID;</span></div><div class="line">	<span class="string">pInitStruct-&gt;pfExportFunctions</span> <span class="string">=</span> <span class="string">ExportFunctions;</span></div><div class="line">	<span class="string">pInitStruct-&gt;pfImportFunctions</span> <span class="string">=</span> <span class="string">ImportFunctions;</span></div><div class="line">	<span class="string">pInitStruct-&gt;pfGetVersion</span> <span class="string">=</span> <span class="string">CmpGetVersion;</span></div><div class="line">	<span class="string">pInitStruct-&gt;pfHookFunction</span> <span class="string">=</span> <span class="string">HookFunction;</span></div><div class="line">	<span class="string">pInitStruct-&gt;pfCreateInstance</span> <span class="string">=</span> <span class="literal">NULL</span><span class="string">;</span></div><div class="line">	<span class="string">pInitStruct-&gt;pfDeleteInstance</span> <span class="string">=</span> <span class="literal">NULL</span><span class="string">;</span></div><div class="line"></div><div class="line">	<span class="string">s_pfCMRegisterAPI</span> <span class="string">=</span> <span class="string">pInitStruct-&gt;pfCMRegisterAPI;</span></div><div class="line">	<span class="string">s_pfCMRegisterAPI2</span> <span class="string">=</span> <span class="string">pInitStruct-&gt;pfCMRegisterAPI2;</span></div><div class="line">	<span class="string">s_pfCMGetAPI</span> <span class="string">=</span> <span class="string">pInitStruct-&gt;pfCMGetAPI;</span></div><div class="line">	<span class="string">s_pfCMGetAPI2</span> <span class="string">=</span> <span class="string">pInitStruct-&gt;pfCMGetAPI2;</span></div><div class="line">	<span class="string">s_pfCMCallHook</span> <span class="string">=</span> <span class="string">pInitStruct-&gt;pfCMCallHook;</span></div><div class="line">	<span class="string">s_pfCMRegisterClass</span> <span class="string">=</span> <span class="string">pInitStruct-&gt;pfCMRegisterClass;</span></div><div class="line">	<span class="string">s_pfCMCreateInstance</span> <span class="string">=</span> <span class="string">pInitStruct-&gt;pfCMCreateInstance;</span></div><div class="line">	<span class="string">return</span> <span class="string">ERR_OK;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line"></div><div class="line"><span class="string">/**</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;description&gt;Publish</span> <span class="string">exported</span> <span class="string">functions</span> <span class="string">to</span> <span class="string">the</span> <span class="string">component</span> <span class="string">manager,</span> <span class="string">to</span> <span class="string">make</span> <span class="string">them</span> <span class="string">available</span> <span class="string">for</span> <span class="string">other</span> <span class="string">components.</span></div><div class="line"> <span class="string">*</span> <span class="string">Use</span> <span class="string">generated</span> <span class="string">macro</span> <span class="string">EXPORT_STMT.&lt;/description&gt;</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;result&gt;ERR_OK</span> <span class="string">or</span> <span class="string">error</span> <span class="string">code</span> <span class="string">in</span> <span class="string">case</span> <span class="string">of</span> <span class="string">error&lt;/result&gt;</span></div><div class="line"> <span class="string">*/</span></div><div class="line"><span class="string">static</span> <span class="string">int</span> <span class="string">CDECL</span> <span class="string">ExportFunctions(void)</span></div><div class="line"><span class="string">&#123;</span></div><div class="line">	<span class="string">/*</span> <span class="string">Macro</span> <span class="string">to</span> <span class="string">export</span> <span class="string">functions</span> <span class="string">*/</span></div><div class="line">	<span class="string">EXPORT_STMT;</span></div><div class="line">	<span class="string">return</span> <span class="string">ERR_OK;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line"></div><div class="line"><span class="string">/**</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;description&gt;Import</span> <span class="string">function</span> <span class="string">pointers</span> <span class="string">from</span> <span class="string">other</span> <span class="string">components.</span> <span class="string">Use</span> <span class="string">generated</span> <span class="string">macro</span> <span class="string">IMPORT_STMT.&lt;/description&gt;</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;result&gt;ERR_OK</span> <span class="string">or</span> <span class="string">error</span> <span class="string">code</span> <span class="string">if</span> <span class="string">function</span> <span class="string">name</span> <span class="string">could</span> <span class="string">not</span> <span class="string">be</span> <span class="string">resolved&lt;/result&gt;</span></div><div class="line"> <span class="string">*/</span></div><div class="line"><span class="string">static</span> <span class="string">int</span> <span class="string">CDECL</span> <span class="string">ImportFunctions(void)</span></div><div class="line"><span class="string">&#123;</span></div><div class="line">	<span class="string">/*</span> <span class="string">Macro</span> <span class="string">to</span> <span class="string">import</span> <span class="string">functions</span> <span class="string">*/</span></div><div class="line">	<span class="string">IMPORT_STMT;</span></div><div class="line">	<span class="string">return</span> <span class="string">ERR_OK;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line"></div><div class="line"><span class="string">/**</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;description&gt;Return</span> <span class="string">the</span> <span class="string">version</span> <span class="string">of</span> <span class="string">our</span> <span class="string">component.&lt;/description&gt;</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;result&gt;Version</span> <span class="string">as</span> <span class="string">defined</span> <span class="string">in</span> <span class="string">dep</span> <span class="string">file&lt;/result&gt;</span></div><div class="line"> <span class="string">*/</span></div><div class="line"><span class="string">static</span> <span class="string">RTS_UI32</span> <span class="string">CDECL</span> <span class="string">CmpGetVersion(void)</span></div><div class="line"><span class="string">&#123;</span></div><div class="line">	<span class="string">return</span> <span class="string">CMP_VERSION;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line"></div><div class="line"><span class="comment">#endif</span></div><div class="line"></div><div class="line"><span class="string">/**</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;description&gt;Hook</span> <span class="string">function</span> <span class="string">to</span> <span class="string">get</span> <span class="string">all</span> <span class="string">broadcast</span> <span class="string">hooks</span> <span class="string">of</span> <span class="string">the</span> <span class="string">component</span> <span class="string">manager.</span> <span class="string">All</span> <span class="string">init</span> <span class="string">and</span> <span class="string">exit</span> <span class="string">stuff</span> <span class="string">must</span> <span class="string">be</span> <span class="string">implemented</span> <span class="string">here!&lt;/description&gt;</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;param</span> <span class="string">name="ulHook"</span> <span class="string">type="IN"&gt;Kind</span> <span class="string">of</span> <span class="string">hook.</span> <span class="string">See</span> <span class="string">CH_</span> <span class="string">definitions</span> <span class="string">in</span> <span class="string">CmpItf.h</span> <span class="string">for</span> <span class="string">details.&lt;/param&gt;</span> </div><div class="line"> <span class="string">*</span> <span class="string">&lt;param</span> <span class="string">name="ulParam1"</span> <span class="string">type="IN"&gt;Hook</span> <span class="string">specific</span> <span class="string">first</span> <span class="string">parameter.</span> <span class="string">See</span> <span class="string">definitions</span> <span class="string">in</span> <span class="string">CmpItf.h</span> <span class="string">for</span> <span class="string">details.&lt;/param&gt;</span> </div><div class="line"> <span class="string">*</span> <span class="string">&lt;param</span> <span class="string">name="ulParam2"</span> <span class="string">type="IN"&gt;Hook</span> <span class="string">specific</span> <span class="string">second</span> <span class="string">parameter.</span> <span class="string">See</span> <span class="string">definitions</span> <span class="string">in</span> <span class="string">CmpItf.h</span> <span class="string">for</span> <span class="string">details.&lt;/param&gt;</span>  </div><div class="line"> <span class="string">*</span> <span class="string">&lt;result&gt;Error</span> <span class="string">code&lt;/result&gt;</span></div><div class="line"> <span class="string">*/</span></div><div class="line"><span class="string">static</span> <span class="string">RTS_RESULT</span> <span class="string">CDECL</span> <span class="string">HookFunction(RTS_UI32</span> <span class="string">ulHook,</span> <span class="string">RTS_UINTPTR</span> <span class="string">ulParam1,</span> <span class="string">RTS_UINTPTR</span> <span class="string">ulParam2)</span></div><div class="line"><span class="string">&#123;</span></div><div class="line">	<span class="string">switch</span> <span class="string">(ulHook)</span></div><div class="line">	<span class="string">&#123;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_INIT:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_INIT2:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_INIT3:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_INIT_TASKS:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_INIT_COMM:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_INIT_FINISHED:</span></div><div class="line">			<span class="string">break;</span></div><div class="line"></div><div class="line">		<span class="string">/*</span> <span class="string">Cyclic</span> <span class="string">*/</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_COMM_CYCLE:</span></div><div class="line">			<span class="string">break;</span></div><div class="line"></div><div class="line"><span class="comment">#ifndef RTS_COMPACT_MICRO</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_EXIT_COMM:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_EXIT_TASKS:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_EXIT3:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_EXIT2:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">		<span class="string">case</span> <span class="attr">CH_EXIT:</span></div><div class="line">			<span class="string">break;</span></div><div class="line"><span class="comment">#endif</span></div><div class="line"></div><div class="line">		<span class="attr">default:</span></div><div class="line">			<span class="string">break;</span></div><div class="line">	<span class="string">&#125;</span></div><div class="line">	<span class="string">return</span> <span class="string">ERR_OK;</span></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure>
</li>
<li><p>拷贝”CmpTemperatureDep.h”到”CODSYS”目录下的”CmpTemperature”文件夹中。</p>
<div class="alert warning no-icon"><p>注意修改代码中<code>#define EXPORT_EXTREF_STMT</code>段中，将最后一段的的反斜杠去掉。<br>代码中的0x8A30DA7C、0x3929FC59两个数据是连接CODSYS和底层平台的接口地址，对库进行修改重新编译后这个值会对应的改变，因此在底层平台中也需要对这两个值进行修改！！！<br>undefined</p>
<p>修改为：<br>undefined</p>
</div>
</li>
<li><p>拷贝”CmpTemperatureItf.h”到”CODSYS”目录下的”CmpTemperature”文件夹中，保留一下代码段，其余删除。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"> <span class="string">/**</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;interfacename&gt;CmpTemperature&lt;/interfacename&gt;</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;description&gt;&lt;/description&gt;</span></div><div class="line"> <span class="string">*</span></div><div class="line"> <span class="string">*</span> <span class="string">&lt;copyright&gt;&lt;/copyright&gt;</span></div><div class="line"> <span class="string">*/</span></div><div class="line"></div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line"><span class="comment">#ifndef _CMPTEMPERATUREITF_H_</span></div><div class="line"><span class="comment">#define _CMPTEMPERATUREITF_H_</span></div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="string">/**</span> <span class="string">EXTERN</span> <span class="string">LIB</span> <span class="string">SECTION</span> <span class="string">BEGIN</span> <span class="string">**/</span></div><div class="line"><span class="string">/*</span>  <span class="string">Comments</span> <span class="string">are</span> <span class="string">ignored</span> <span class="string">for</span> <span class="string">m4</span> <span class="string">compiler</span> <span class="string">so</span> <span class="string">restructured</span> <span class="string">text</span> <span class="string">can</span> <span class="string">be</span> <span class="string">used.</span>  <span class="string">*/</span></div><div class="line"></div><div class="line"><span class="comment">#ifdef __cplusplus</span></div><div class="line"><span class="string">extern</span> <span class="string">"C"</span> <span class="string">&#123;</span></div><div class="line"><span class="comment">#endif</span></div></pre></td></tr></table></figure>
</li>
<li><p>在”CMP”文件夹中新建文件夹”Temperature”，在文件夹”Temperature”下新建文件夹”header”、”source”，在文件夹”header”下新建头文件”mcTemperatureRegulatorFB.h”，具体内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>	<span class="string">NAME</span> <span class="string">OF</span> <span class="attr">PROJECT:</span> <span class="string">xxxxxxx</span>					  					 <span class="attr">Version:</span> <span class="number">1.0</span> <span class="string">(development)</span> <span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>	<span class="string">NAME</span> <span class="string">OF</span> <span class="string">SOURCE</span> <span class="attr">FILE:</span> <span class="string">MC_TEMPERATUREREGULATORFB.h</span> 					  							<span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>																		  																			<span class="string">//</span></div><div class="line"><span class="string">//</span>	<span class="string">Data</span> <span class="string">of</span> <span class="attr">creation:</span> <span class="number">2018.04</span><span class="number">.10</span>										  												<span class="string">//</span></div><div class="line"><span class="string">//</span>	<span class="string">Data</span> <span class="string">of</span> <span class="string">last</span> <span class="attr">modification:</span> <span class="number">2016.04</span><span class="number">.10</span>								  										<span class="string">//</span></div><div class="line"><span class="string">//</span>																		  																			<span class="string">//</span></div><div class="line"><span class="string">//</span>	<span class="attr">DESCRIPTION:</span>                                                              <span class="string">//</span></div><div class="line"><span class="string">//</span>                                                                            <span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>	<span class="string">NAME</span> <span class="string">OF</span> <span class="string">PROJECT</span> <span class="attr">FILE:</span> 			  													<span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>	<span class="string">UTILIZING</span> <span class="attr">COMPILER:</span> <span class="string">Texas</span> <span class="string">Instrument</span> <span class="string">Code</span> <span class="string">Composer</span> <span class="string">Studio</span> <span class="string">V6</span>							<span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>							<span class="string">XXX</span> <span class="string">Xxx</span> <span class="bullet">-</span> <span class="string">Xxxxx</span>						  															<span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"></div><div class="line"><span class="comment">#ifndef _MC_TEMPERATUREREGULATORFB_H_</span></div><div class="line"><span class="comment">#define _MC_TEMPERATUREREGULATORFB_H_</span></div><div class="line"></div><div class="line"><span class="comment">#endif /*_CMPTEMPERATUREITF_H_*/</span></div><div class="line"><span class="string">```</span> </div><div class="line"><span class="number">4.</span> <span class="string">拷贝"CmpTemperatureItf.h"头文件中字段`/**</span> <span class="string">EXTERN</span> <span class="string">LIB</span> <span class="string">SECTION</span> <span class="string">BEGIN</span> <span class="string">**/`和`/**</span> <span class="string">EXTERN</span> <span class="string">LIB</span> <span class="string">SECTION</span> <span class="string">END</span> <span class="string">**/`之间的内容到"mcTemperatureRegulatorFB.h"中。</span></div><div class="line"><span class="number">5.</span> <span class="string">在文件夹"source"下新建C文件"mcTemperatureRegulatorFB.c"，具体内容如下（其中头文件根据实际目录进行添加和修改）：</span></div><div class="line"><span class="string">```</span> <span class="string">yaml</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>	<span class="string">NAME</span> <span class="string">OF</span> <span class="attr">PROJECT:</span> <span class="string">xxxxxx</span>					  					 <span class="attr">Version:</span> <span class="number">1.0</span> <span class="string">(development)</span> <span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>	<span class="string">NAME</span> <span class="string">OF</span> <span class="string">SOURCE</span> <span class="attr">FILE:</span> <span class="string">MC_TEMPERATUREREGULATORFB.c</span> 					  							<span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>																		  																			<span class="string">//</span></div><div class="line"><span class="string">//</span>	<span class="string">Data</span> <span class="string">of</span> <span class="attr">creation:</span> <span class="number">2018.04</span><span class="number">.10</span>										  												<span class="string">//</span></div><div class="line"><span class="string">//</span>	<span class="string">Data</span> <span class="string">of</span> <span class="string">last</span> <span class="attr">modification:</span> <span class="number">2016.04</span><span class="number">.10</span>								  										<span class="string">//</span></div><div class="line"><span class="string">//</span>																		  																			<span class="string">//</span></div><div class="line"><span class="string">//</span>	<span class="attr">DESCRIPTION:</span>                                                              <span class="string">//</span></div><div class="line"><span class="string">//</span>                                                                            <span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>	<span class="string">NAME</span> <span class="string">OF</span> <span class="string">PROJECT</span> <span class="attr">FILE:</span> 			  													<span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>	<span class="string">UTILIZING</span> <span class="attr">COMPILER:</span> <span class="string">Texas</span> <span class="string">Instrument</span> <span class="string">Code</span> <span class="string">Composer</span> <span class="string">Studio</span> <span class="string">V6</span>							<span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"><span class="string">//</span>							<span class="string">XXX</span> <span class="string">Xxx</span> <span class="bullet">-</span> <span class="string">Xxxxx</span>						  															<span class="string">//</span></div><div class="line"><span class="string">//----------------------------------------------------------------------------//</span></div><div class="line"></div><div class="line"><span class="string">//</span> <span class="string">type</span> <span class="string">defines</span></div><div class="line"><span class="comment">#include &lt;stdbool.h&gt;</span></div><div class="line"><span class="comment">#include &lt;stdint.h&gt;</span></div><div class="line"></div><div class="line"><span class="string">//</span> <span class="string">application</span> <span class="string">include</span></div><div class="line"><span class="comment">#include "../../../../Library/Type/LIB_Type.h"</span></div><div class="line"></div><div class="line"><span class="comment">#include "../../../common/Defines.h"</span></div><div class="line"></div><div class="line"><span class="comment">#include "../../../API/header/configuration.h"</span></div><div class="line"></div><div class="line"><span class="comment">#include "../../../PLC/header/PLCShare.h"</span></div><div class="line"></div><div class="line"><span class="comment">#include "../../../COM/header/chatUSB.h"</span></div><div class="line"></div><div class="line"><span class="comment">#include "../../../../Third/CODESYS/Includes/CmpStd.h"</span></div><div class="line"></div><div class="line"><span class="comment">#include "../../include/mcReference.h"</span></div><div class="line"><span class="comment">#include "../header/mcTemperatureRegulatorFB.h"</span></div></pre></td></tr></table></figure>
</li>
<li><p>拷贝”CmpTemperature.c”文件中的函数定义到”mcTemperatureRegulatorFB.c”文件中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">void</span> <span class="string">CDECL</span> <span class="string">CDECL_EXT</span> <span class="string">mc_temperatureregulator__fb_init(mc_temperatureregulator_fb_init_struct</span> <span class="string">*p)</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"></div><div class="line"><span class="string">&#125;</span></div><div class="line"></div><div class="line"><span class="string">void</span> <span class="string">CDECL</span> <span class="string">CDECL_EXT</span> <span class="string">mc_temperatureregulator__main(mc_temperatureregulator_main_struct</span> <span class="string">*p)</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure>
</li>
<li><p>具体函数的实现功能，由用户在以上函数中进行实现，至此我们已经完成了从CODSYS建立FB到移植底层平台的所有步骤。</p>
</li>
</ol>

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/PLC/">PLC</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/03/24/Allegro添加Logo利器/" data-tooltip="Allegro添加Logo利器">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
<ul class="post-actions post-action-share">
        <li class="post-action">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至Twitter" href="http://www.jiathis.com/send/?webid=twitter&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        <li class="post-action">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至QQ空间" href="http://www.jiathis.com/send/?webid=qzone&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-qq"></i>
            </a>
        </li>
        <li class="post-action">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至人人网" href="http://www.jiathis.com/send/?webid=renren&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-renren"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至微信" href="http://www.jiathis.com/send/?webid=weixin&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-weixin"></i>
            </a>
        </li>        
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至新浪微博" href="http://www.jiathis.com/send/?webid=tsina&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-weibo"></i>
            </a>
        </li>
    </ul>
</div>


        
            
                <div id="ds-thread" class="ds-thread" data-thread-key="2018/04/10/CODSYS功能块建库移植到底层平台/"
     data-title="CODSYS功能块建库移植到底层平台" data-url="http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/">
</div>

            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2018 Tornado. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/03/24/Allegro添加Logo利器/" data-tooltip="Allegro添加Logo利器">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
<ul class="post-actions post-action-share">
        <li class="post-action">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至Twitter" href="http://www.jiathis.com/send/?webid=twitter&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        <li class="post-action">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至QQ空间" href="http://www.jiathis.com/send/?webid=qzone&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-qq"></i>
            </a>
        </li>
        <li class="post-action">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至人人网" href="http://www.jiathis.com/send/?webid=renren&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-renren"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至微信" href="http://www.jiathis.com/send/?webid=weixin&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-weixin"></i>
            </a>
        </li>        
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至新浪微博" href="http://www.jiathis.com/send/?webid=tsina&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-weibo"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="3">
    <ul class="share-options">
        <li class="share-option">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至QQ空间" href="http://www.jiathis.com/send/?webid=qzone&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-qq"></i>
            </a>
        </li>
        <li class="share-option">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至微信" href="http://www.jiathis.com/send/?webid=weixin&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-weixin"></i>
            </a>
        </li>
        <li class="share-option">
            <a class="post-action-btn btn btn--default tooltip--top" target="new" data-tooltip="分享至新浪微博" href="http://www.jiathis.com/send/?webid=tsina&amp;appkey=&amp;uid=chinaluou&amp;url=http://chinaluou.github.io/2018/04/10/CODSYS功能块建库移植到底层平台/&amp;title=CODSYS功能块建库移植到底层平台">
                <i class="fa fa-weibo"></i>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/head.jpeg"/>
        
            <h4 id="about-card-name">Tornado</h4>
        
            <h5 id="about-card-bio"><p>读书、编程、跑步、教育、投资······</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>自由的程序猿</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                浙江省宁波市
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script-i4qo6jx6jji9fg0dftpya6ivemizsbow4fhow76d8dwpm7m1wbvi378ssumx.min.js"></script>
<!--SCRIPTS END-->

    
        <script type="text/javascript">
            var duoshuoQuery = {short_name:'chinaluou'};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        </script>
    



</html>
